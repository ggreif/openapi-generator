{{#models}}
{{#imports}}
{{#isMap}}import { type Map } "mo:core/pure/Map";
{{/isMap}}{{^isMappedType}}
import { type {{import}}; JSON = {{import}} } "./{{import}}";
{{/isMappedType}}
{{/imports}}

{{#model}}
{{#isEnum}}
// {{classname}}.mo
{{#description}}
/// {{{description}}}
{{/description}}
/// Enum values: {{#allowableValues}}{{#enumVars}}#{{name}}{{^-last}}, {{/-last}}{{/enumVars}}{{/allowableValues}}

module {
    // Motoko-facing type: type-safe variants for application code
    public type {{classname}} = {
{{#allowableValues}}
{{#enumVars}}
        {{#enumDescription}}
        /// {{{enumDescription}}}
        {{/enumDescription}}
        #{{name}};
{{/enumVars}}
{{/allowableValues}}
    };

    // JSON sub-module: everything needed for JSON serialization
    public module JSON {
        // JSON-facing Motoko type: mirrors JSON structure
        // Named "JSON" to avoid shadowing the outer {{classname}} type
        public type JSON = {{dataType}};

        // Convert Motoko-facing type to JSON-facing Motoko type
        public func toJSON(value : {{classname}}) : JSON =
            switch (value) {
{{#allowableValues}}
{{#enumVars}}
                case (#{{name}}) {{#isString}}"{{value}}"{{/isString}}{{^isString}}{{value}}{{/isString}};
{{/enumVars}}
{{/allowableValues}}
            };

        // Convert JSON-facing Motoko type to Motoko-facing type
        public func fromJSON(json : JSON) : ?{{classname}} =
            switch (json) {
{{#allowableValues}}
{{#enumVars}}
                case {{#isString}}"{{value}}"{{/isString}}{{^isString}}{{value}}{{/isString}} ?#{{name}};
{{/enumVars}}
{{/allowableValues}}
                case _ null;
            };
    }
}
{{/isEnum}}
{{^isEnum}}
// {{classname}}.mo
{{#description}}
/// {{{description}}}
{{/description}}

module {
    // Motoko-facing type: what application code uses
    public type {{classname}} = {
{{#vars}}
        {{#description}}
        /// {{{description}}}
        {{/description}}
        {{name}} : {{^required}}?{{/required}}{{{dataType}}};
{{/vars}}
    };

    // JSON sub-module: everything needed for JSON serialization
    public module JSON {
        // JSON-facing Motoko type: mirrors JSON structure
        // Named "JSON" to avoid shadowing the outer {{classname}} type
        public type JSON = {
{{#vars}}
            {{name}} : {{^required}}?{{/required}}{{#isEnumRef}}{{{datatypeWithEnum}}}.JSON{{/isEnumRef}}{{^isEnumRef}}{{#vendorExtensions.xNeedsJsonConversion}}{{{dataType}}}.JSON{{/vendorExtensions.xNeedsJsonConversion}}{{^vendorExtensions.xNeedsJsonConversion}}{{{dataType}}}{{/vendorExtensions.xNeedsJsonConversion}}{{/isEnumRef}};
{{/vars}}
        };

        // Convert Motoko-facing type to JSON-facing Motoko type
        public func toJSON(value : {{classname}}) : JSON = {{#vendorExtensions.xNoEnumFields}}value{{/vendorExtensions.xNoEnumFields}}{{^vendorExtensions.xNoEnumFields}}{{#vendorExtensions.xHasPartialTransform}}{ value with
{{#vars}}
{{#isEnumRef}}
            {{name}} = {{#required}}{{{datatypeWithEnum}}}.toJSON(value.{{name}}){{/required}}{{^required}}switch (value.{{name}}) { case (?v) ?{{{datatypeWithEnum}}}.toJSON(v); case null null }{{/required}};
{{/isEnumRef}}
{{^isEnumRef}}
{{#vendorExtensions.xNeedsJsonConversion}}
            {{name}} = {{#required}}{{{dataType}}}.toJSON(value.{{name}}){{/required}}{{^required}}switch (value.{{name}}) { case (?v) ?{{{dataType}}}.toJSON(v); case null null }{{/required}};
{{/vendorExtensions.xNeedsJsonConversion}}
{{/isEnumRef}}
{{/vars}}
        }{{/vendorExtensions.xHasPartialTransform}}{{^vendorExtensions.xHasPartialTransform}}{
{{#vars}}
            {{name}} = {{#required}}{{#isEnumRef}}{{{datatypeWithEnum}}}.toJSON(value.{{name}}){{/isEnumRef}}{{^isEnumRef}}{{#vendorExtensions.xNeedsJsonConversion}}{{{dataType}}}.toJSON(value.{{name}}){{/vendorExtensions.xNeedsJsonConversion}}{{^vendorExtensions.xNeedsJsonConversion}}value.{{name}}{{/vendorExtensions.xNeedsJsonConversion}}{{/isEnumRef}}{{/required}}{{^required}}{{#isEnumRef}}switch (value.{{name}}) { case (?v) ?{{{datatypeWithEnum}}}.toJSON(v); case null null }{{/isEnumRef}}{{^isEnumRef}}{{#vendorExtensions.xNeedsJsonConversion}}switch (value.{{name}}) { case (?v) ?{{{dataType}}}.toJSON(v); case null null }{{/vendorExtensions.xNeedsJsonConversion}}{{^vendorExtensions.xNeedsJsonConversion}}value.{{name}}{{/vendorExtensions.xNeedsJsonConversion}}{{/isEnumRef}}{{/required}};
{{/vars}}
        }{{/vendorExtensions.xHasPartialTransform}}{{/vendorExtensions.xNoEnumFields}};

        // Convert JSON-facing Motoko type to Motoko-facing type
        public func fromJSON(json : JSON) : ?{{classname}} {{#vendorExtensions.xNoEnumFields}}= ?json{{/vendorExtensions.xNoEnumFields}}{{^vendorExtensions.xNoEnumFields}}{{#vendorExtensions.xHasPartialTransform}}{
{{#vars}}
{{#required}}
{{#isEnumRef}}
            let ?{{name}} = {{{datatypeWithEnum}}}.fromJSON(json.{{name}}) else return null;
{{/isEnumRef}}
{{^isEnumRef}}
{{#vendorExtensions.xNeedsJsonConversion}}
            let ?{{name}} = {{{dataType}}}.fromJSON(json.{{name}}) else return null;
{{/vendorExtensions.xNeedsJsonConversion}}
{{/isEnumRef}}
{{/required}}
{{/vars}}
            ?{ json with
{{#vars}}
{{#isEnumRef}}
                {{name}}{{#required}}{{/required}}{{^required}} = switch (json.{{name}}) { case (?v) {{{datatypeWithEnum}}}.fromJSON(v); case null null }{{/required}};
{{/isEnumRef}}
{{^isEnumRef}}
{{#vendorExtensions.xNeedsJsonConversion}}
                {{name}}{{#required}}{{/required}}{{^required}} = switch (json.{{name}}) { case (?v) {{{dataType}}}.fromJSON(v); case null null }{{/required}};
{{/vendorExtensions.xNeedsJsonConversion}}
{{/isEnumRef}}
{{/vars}}
            }
        }{{/vendorExtensions.xHasPartialTransform}}{{^vendorExtensions.xHasPartialTransform}}{
{{#vars}}
{{#required}}
{{#isEnumRef}}
            let ?{{name}} = {{{datatypeWithEnum}}}.fromJSON(json.{{name}}) else return null;
{{/isEnumRef}}
{{^isEnumRef}}
{{#vendorExtensions.xNeedsJsonConversion}}
            let ?{{name}} = {{{dataType}}}.fromJSON(json.{{name}}) else return null;
{{/vendorExtensions.xNeedsJsonConversion}}
{{/isEnumRef}}
{{/required}}
{{/vars}}
            ?{
{{#vars}}
                {{name}}{{#required}}{{^isEnumRef}}{{^vendorExtensions.xNeedsJsonConversion}} = json.{{name}}{{/vendorExtensions.xNeedsJsonConversion}}{{/isEnumRef}}{{/required}}{{^required}} = {{#isEnumRef}}switch (json.{{name}}) { case (?v) {{{datatypeWithEnum}}}.fromJSON(v); case null null }{{/isEnumRef}}{{^isEnumRef}}{{#vendorExtensions.xNeedsJsonConversion}}switch (json.{{name}}) { case (?v) {{{dataType}}}.fromJSON(v); case null null }{{/vendorExtensions.xNeedsJsonConversion}}{{^vendorExtensions.xNeedsJsonConversion}}json.{{name}}{{/vendorExtensions.xNeedsJsonConversion}}{{/isEnumRef}}{{/required}};
{{/vars}}
            }
        }{{/vendorExtensions.xHasPartialTransform}}{{/vendorExtensions.xNoEnumFields}};
    }
}
{{/isEnum}}
{{/model}}
{{/models}}
